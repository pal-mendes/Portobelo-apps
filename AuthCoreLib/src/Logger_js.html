
// =========================
// File: Logger_js.html - em AuthCoreLib (biblioteca)
// =========================
// Logger_js.html (logo no início do script, antes de exportares log/dbg)
(function () {
  try {
    const here = location.origin + location.pathname;

    // Se estamos no host "interno" (googleusercontent), este é o self certo.
    // (A condição pode ser só hostname; o pathname depende do teu caso.)
    const isUserCodeHost = /-script\.googleusercontent\.com$/i.test(location.hostname);

    if (isUserCodeHost) {
      try { localStorage.setItem("appCanonicalUrl", here); } catch (_) {}
    }

    let self = "";
    try { self = localStorage.getItem("appCanonicalUrl") || ""; } catch (_) {}
    if (!self) self = here;

    window.CANON_SELF = self;
  } catch (_) {
    // fallback extremo
    window.CANON_SELF = location.origin + location.pathname;
  }
})();

/* PB Logger — 2.º <script> no <head> */
(function () {
  var SV  = window.__SERVER_VARS || {};
  var QK  = 'debug';
  var LSK = 'pbDebug';

  function hasDebugInQuery(){
    try {
      var qs = new URLSearchParams(location.search);
      return qs.has(QK) && (qs.get(QK) === null || qs.get(QK) === '' || qs.get(QK) === '1');
    } catch(_) { return false; }
  }
  function hasDebugInLS(){ try { return localStorage.getItem(LSK) === '1'; } catch(_) { return false; } }

  var DEBUG_ENABLED = !!(SV.debugServer || hasDebugInQuery() || hasDebugInLS());
  window.DEBUG = DEBUG_ENABLED;

  function out(kind, args){
    var tag = SV.pageTag ? ('['+SV.pageTag+']') : '[PB]';
    try { console[kind].apply(console, [tag].concat([].slice.call(args))); } catch(_) {}
  }

  // API (redeclara por cima dos stubs)
  window.log  = function(){ out('log',   arguments); };
  window.warn = function(){ out('warn',  arguments); };
  window.err  = function(){ out('error', arguments); };
  window.dbg  = DEBUG_ENABLED ? window.log : function(){};

  // Conveniências
  window.enableDebug  = function(on){ try{ on?localStorage.setItem(LSK,'1'):localStorage.removeItem(LSK); location.reload(); }catch(_){} };
  window.disableDebug = function(){ window.enableDebug(false); };

  // Erros globais (sempre)
  window.addEventListener('error', e => {
    var st = (e && e.error && e.error.stack) || '';
    window.err('JS error:', e && e.message, st);
  });
  window.addEventListener('unhandledrejection', e => {
    var r=e && e.reason; window.err('Promise rejection:', r && r.message || r, r && r.stack || '');
  });

  // Boot trace
  document.addEventListener('DOMContentLoaded', function(){
    var sl = SV.serverLog || '';
    if (sl) sl.split('\n').forEach(l => l && window.log(l));
    window.dbg('DOM ready:', location.href);
    if (document.referrer) window.dbg('Referrer:', document.referrer);
    try { window.dbg('embedded?', window.top !== window); } catch(_) {}
    try { if (SV.canonUrl) window.dbg('canon origin=', new URL(SV.canonUrl).origin); } catch(_) {}
  });
})();
