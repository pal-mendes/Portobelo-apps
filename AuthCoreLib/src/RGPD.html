
<!-- RGPD.html (em AuthCoreLib) -->
<!doctype html>
<html>
  <head>
    <base target="_self" />
    <meta charset="utf-8" />
    <title>RGPD</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        max-width: 820px;
        margin: 18px auto;
        padding: 0 14px;
        line-height: 1.45;
      }
      .card {
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 14px;
      }
      .row {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      button {
        padding: 8px 12px;
        border: 1px solid #999;
        border-radius: 8px;
        background: #fff;
        cursor: pointer;
      }
    </style>

    <script>
    /* PB Server Vars — 1.º <script> no <head> (sem efeitos colaterais) */
    (function () {
      // Defensivo: usar typeof para evitar ReferenceError no template
      var SV = { //usar como __SERVER_VARS. no código
        canonUrl:   "<?= (typeof CANON_URL  !== 'undefined' ? CANON_URL  : '') ?>",
        ticket:     "<?= (typeof TICKET     !== 'undefined' ? TICKET     : (typeof ticket !== 'undefined' ? ticket : '')) ?>",
        autostart:  "<?= (typeof AUTOSTART  !== 'undefined' ? AUTOSTART  : '') ?>",   // '1' | ''
        debugServer:"<?= (typeof DEBUG      !== 'undefined' ? DEBUG      : '') ?>" === "1",
        serverLog:  `<?= (typeof SERVER_LOG !== 'undefined' ? SERVER_LOG : '') ?>`,
        wipe:       "<?= (typeof WIPE       !== 'undefined' ? WIPE       : '') ?>",   // '1' | ''
        pageTag:    "<?= (typeof PAGE_TAG   !== 'undefined' ? PAGE_TAG   : '') ?>" // etiqueta para prefixo nos logs ex.: 'LOGIN' | 'RGPD' | 'MAIN'
      };

      // Flags calculadas no cliente
      SV.noRedirect = /[?&]noredirect=1\b/i.test(location.search);

      const CANON_SELF = location.origin + location.pathname;

      SV.canonSelf = CANON_SELF;
      window.CANON_SELF = CANON_SELF;

      // Persistir
      try { localStorage.setItem("appSelfUrl", CANON_SELF); } catch(_) {}
      try { if ((SV.canonUrl || "").trim()) localStorage.setItem("appCanonicalUrl", SV.canonUrl.trim()); } catch(_) {}

      // Expor de forma limpa
      window.__SERVER_VARS = Object.freeze(SV);

      // Ponte mínima (se quiser eliminar depois, pode)
      window.CANON_URL      = SV.canonUrl;
      window.SESSION_TICKET = SV.ticket;
      window.SERVER_LOG     = SV.serverLog;

      // --- Stubs anti-erro: garantem que log/dbg existem MESMO antes do logger carregar
      window.log = window.log || function(){ try{ console.log.apply(console, arguments); }catch(_){} };
      window.dbg = window.dbg || function(){};
  })();
  </script>

  <!-- Logger global único (consola apenas) - no head dos html e servido pela AuthCoreLib. Aponta para a implementação B pois tem de ser web App -->
  <!--  <script src="https://script.google.com/macros/s/AKfycbw7CwrEid8YLInikNcmpqz9l9GzGFU40zTLL5mrTokCHiSgXivy4WQK6TbekB18tQ59/exec"></script>  -->
  <script>
    <?!= HtmlService.createHtmlOutputFromFile('Logger_js').getContent(); ?>
  </script>
    
  </head>
  <body>
    <h2>Proteção de dados (RGPD)</h2>
    <div class="card">
      <p><b>REGULAMENTO DA ASSOCIAÇÃO DOS TITULARES DE DRHP DO PORTOBELO</b></p>
      <p><b>Artigo 9.º — Proteção de dados</b></p>
      <ol>
        <li>
          A Associação recolhe e trata dados pessoais dos associados
          estritamente necessários ao cumprimento dos seus fins, designadamente
          identificação, contactos e dados relativos às semanas detidas.
        </li>
        <li>
          A Associação compromete-se a adotar medidas técnicas e organizativas
          adequadas para a proteção desses dados.
        </li>
        <li>
          Os dados serão usados apenas para fins associativos, com respeito pelo
          RGPD e legislação nacional.
        </li>
        <li>
          Os associados têm direito a aceder, retificar e solicitar a eliminação
          dos seus dados, salvo os que sejam legalmente obrigatórios para o
          funcionamento da Associação.
        </li>
      </ol>
      <div id="rgpd-multi" style="display: none; margin: 12px 0"></div>
      <div id="rgpd-multi-actions" style="display: none; margin: 12px 0">
        <button id="rgpd-save" class="btn">Guardar</button>
      </div>
    </div>

    <script>
      (function () {

        log(`RGPD page`);

        const WANT_DEBUG  = window.DEBUG;

        //let CANON  = (__SERVER_VARS.canonUrl || (function(){ try{return localStorage.getItem('appCanonicalUrl')}catch(_){return ''} })() || (location.origin + location.pathname));
        let CANON  = (__SERVER_VARS.canonUrl || (function(){ try{return localStorage.getItem('appCanonicalUrl')}catch(_){return ''} })() || '');
        if (!CANON) {
          try { CANON = localStorage.getItem('appCanonicalUrl') || ''; } catch(_) {}
          if (!CANON) CANON = location.origin + location.pathname;
        }

        let TICKET = (__SERVER_VARS.ticket || (new URL(location.href).searchParams.get('ticket') || (function(){ try{return localStorage.getItem('sessTicket')}catch(_){return ''} })()));
        if (!TICKET) {
          // 1) tenta apanhar do URL (vindo do Main com ?ticket=…)
          try { TICKET = new URL(location.href).searchParams.get('ticket') || ''; } catch(_) {}
        }
        if (!TICKET) {
          // 2) último recurso: localStorage (só funciona se mesma origem)
          try { TICKET = localStorage.getItem('sessTicket') || ''; } catch(_) {}
        }


        log(`RGPD page ready; CANON=${CANON}; have TICKET=${!!TICKET}`);

        function spanChip(txt){
          return `<span style="display:inline-block;border:1px solid #e5e7eb;border-radius:999px;padding:2px 8px;background:#eef2ff;font-family:ui-monospace,monospace">${String(txt||"").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</span>`;
        }

        function canonExec() {
          // 1) vindo do servidor (template)
          const fromServer = (CANON || '').trim();
          if (fromServer) return fromServer;

          // 2) persistido (melhor opção quando está em iframe/container)
          try {
            const fromLs = (localStorage.getItem("appCanonicalUrl") || "").trim();
            if (fromLs) return fromLs;
          } catch (_) {}

          // 3) último recurso: o próprio URL atual (pode ser googleusercontent, mas é fallback)
          return (location.origin + location.pathname);
        }

        function navReplace(where) {
          const url = String(where || '');
          log("[RGPD] replace → " + url);
          location.replace(url);
        }

        function goWithParams(params) {
          const u = new URL(canonExec());
          Object.entries(params || {}).forEach(([k, v]) => {
            if (v !== undefined && v !== null && v !== "") u.searchParams.set(k, String(v));
          });
          if (!u.searchParams.has('ts')) u.searchParams.set('ts', String(Date.now()));
          const where = u.toString();
          navReplace(where);
        }

        function renderMulti(rows){
          log("[RGPD/multi] entrada");
          try { log("[RGPD/multi] rows=" + JSON.stringify(rows)); } catch(_){}
          if (!rows || !rows.length){
            log("[RGPD/multi] nenhuma linha para este utilizador");
            const box = document.getElementById('rgpd-multi');
            box.style.display = '';
            box.innerHTML = `
              <div class="card">
                <div class="muted">Não há linhas para gerir o RGPD neste e-mail.</div>
                <div style="margin-top:8px">
                  <button id="rgpd-back">Voltar</button>
                </div>
              </div>`;
            document.getElementById('rgpd-back')?.addEventListener('click', () => {
              const u = new URL(canonExec());
              if (TICKET) u.searchParams.set("ticket", TICKET);
              if (WANT_DEBUG)    u.searchParams.set("debug", "1");
              if (!u.searchParams.has("ts")) u.searchParams.set("ts", String(Date.now()));
              navReplace(u.toString());
            });
            return;
          }

          log("[RGPD/multi] criar html");
          // constroi cards com checkboxes
          const html = rows.map(r => `
            <div class="card" style="border:1px solid #e5e7eb;border-radius:10px;padding:10px;margin:8px 0">
              <label style="display:flex;gap:10px;align-items:center;cursor:pointer">
                <input type="checkbox" data-row="${r.row}" ${r.rgpd ? "checked":""}>
                <div>
                  <div><b>Semana(s)</b> ${spanChip(r.semanas)}</div>
                  <div class="muted small rgpd-label">RGPD: ${r.rgpd ? "Aceite" : "Rejeitado"}</div>
                </div>
              </label>
            </div>
          `).join("");

          const box = document.getElementById('rgpd-multi');
          box.innerHTML = html;
          box.style.display = '';

          // Atualiza rótulo “RGPD: …” em tempo real
          box.querySelectorAll('input[type="checkbox"][data-row]').forEach(cb => {
            const row = +cb.getAttribute('data-row');
            const lab = cb.closest('.card')?.querySelector('.rgpd-label');
            const update = () => {
              const on = !!cb.checked;
              if (lab) lab.textContent = 'RGPD: ' + (on ? 'Aceite' : 'Rejeitado');
              log(`[RGPD/multi] toggle row=${row} → ${on ? 'Aceite' : 'Rejeitado'}`);
            };
            cb.addEventListener('change', update);
          });

          const actions = document.getElementById('rgpd-multi-actions');
          actions.style.display = '';

          const btn = document.getElementById("rgpd-save");

          btn.disabled = false;
          btn.textContent = "Guardar";
          btn.addEventListener("click", function () {

            const accepted = Array.from(box.querySelectorAll('input[type="checkbox"][data-row]'))
              .filter(el => el.checked)
              .map(el => Number(el.dataset.row))
              .filter(n => Number.isFinite(n));
            log("[RGPD/multi] save click");
            log("[RGPD/multi] accepted rows = " + JSON.stringify(accepted));
            //if (!accepted.length) return;

            btn.disabled = true;
            btn.textContent = "A gravar…";

            google.script.run
              .withSuccessHandler(function () {
                status.textContent = "RGPD atualizado.\nA avançar… Se não avançar, clique aqui.";
                //document.getElementById("continue").href = buildBaseUrl().toString();
                try { localStorage.setItem("rgpdAccepted", "1"); } catch(_) {}
                goWithParams({
                  action: "postrgpd",
                  ticket: TICKET,
                  rows: accepted.length ? accepted.join(",") : "", // opcional
                  from: "rgpd-save",
                  debug: WANT_DEBUG ? "1" : ""
                });
              })
              .withFailureHandler(function(err){
                alert("RGPD Erro a atualizar: " + (err && err.message ? err.message : String(err)));
              })
              .setRgpdRowsFor(TICKET, accepted);
          });


        }

        log("RGPD about to call listRgpdRowsFor (host)"); //!
        // Chama o host para obter linhas; se vier vazio, a página da biblioteca fica no modo single padrão
        google.script.run
          .withSuccessHandler(renderMulti)
          .withFailureHandler(function(err){
            alert("Erro a carregar linhas: " + (err && err.message ? err.message : String(err)));
          })
          .listRgpdRowsFor(TICKET);
      })();
    </script>
  </body>
</html>
